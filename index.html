<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Snake Teams 12x12</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<style>
  :root{
    --bg1:#0f0f14; --bg2:#171923; --card:#12131b; --card2:#0e0f15;
    --line:#242634; --line2:#2c3041; --white:#e9eef6;
    --blue:#4db8ff; --blue2:#1e86ff; --green:#6de586; --green2:#1fd36e; --egg:#fde47a;
    --glow:#5dd1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--white);
    background: radial-gradient(1200px 800px at 20% 0%, #141726 0%, #0f111a 55%, #0a0a0e 100%);
  }
  .wrap{max-width:1000px;margin:0 auto;padding:20px 16px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .brand{font-weight:800;letter-spacing:.4px;background: linear-gradient(90deg,var(--blue),var(--green));-webkit-background-clip:text;background-clip:text;color:transparent;font-size:22px}
  .panel{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid #1f2230;border-radius:16px;padding:12px 16px;box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02)}
  #hud{display:grid;grid-template-columns:1.3fr 1fr auto;gap:14px}
  .metric{display:flex;align-items:center;gap:10px;font-weight:600}
  .badge{padding:3px 8px;border-radius:999px;border:1px solid #263149;background:#10121b;color:#a7b5d1;font-size:12px}
  .blue{color:var(--blue)} .green{color:var(--green)}
  button{background:linear-gradient(180deg,#171a29,#121523);border:1px solid #263149;color:var(--white);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;letter-spacing:.2px;box-shadow:0 6px 20px rgba(0,0,0,.4)}
  button:hover{filter:brightness(1.1)}
  #stage{display:grid;grid-template-columns: 1fr 320px;gap:16px;margin-top:14px}
  #canvasWrap{position:relative}
  #canvas{display:block;width:min(84vmin,640px);height:auto;background:linear-gradient(180deg,#f9ddd3,#f3cec2);border:2px solid #303547;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 4px 18px rgba(255,255,255,.25)}
  #legend{position:relative}
  .key{background:#0d0f17;border:1px solid #2a3044;border-radius:12px;padding:10px 12px;margin-bottom:10px}
  .kbd{background:#0c0e16;border:1px solid #313854;padding:2px 8px;border-radius:8px;font-family:monospace;color:#dfe7ff}
  #result{white-space:pre-line;font-family:ui-monospace,Consolas,monospace}

  /* Encadr√© R√àGLES */
  .rules { max-height: 280px; overflow: auto; }
  .rules h3 {
    margin: 0 0 6px 0; font-size: 14px; letter-spacing:.3px;
    background: linear-gradient(90deg,var(--blue),var(--green));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .rules .muted { opacity:.8; font-size:12px; margin-bottom:8px; }
  .rules ul { margin:0; padding-left:18px; }
  .rules li { margin:6px 0; line-height:1.35; }
  #toggleRules { width:100%; margin-bottom:8px; }
  .hidden { display:none; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">SNAKE TEAMS ¬∑ 12√ó12</div>
    <div class="badge">Arcade Arena</div>
  </header>

  <div id="hud" class="panel">
    <div class="metric">‚è±Ô∏è <span style="opacity:.7">Temps</span>: <span id="time" style="margin-left:6px">120.0</span>s</div>
    <div class="metric"><span class="blue">Bleu</span>&nbsp;‚ñ∂ Total&nbsp;<span id="scoreBlue">0</span></div>
    <div class="metric"><span class="green">Vert</span>&nbsp;‚ñ∂ Total&nbsp;<span id="scoreGreen">0</span></div>
    <div class="metric">üèÜ Record serpent: <span id="record">0</span></div>
    <div style="grid-column:1/4;display:flex;gap:10px;align-items:center">
      <button id="restart">RECOMMENCER PARTIE</button>
      <small style="opacity:.7">√âgalit√© ‚ûú 1. plus grande queue ¬∑ 2. robots vivants ¬∑ 3. plus proche du centre</small>
    </div>
  </div>

  <section id="stage">
    <div id="canvasWrap"><canvas id="canvas" width="480" height="480" aria-label="terrain 12x12"></canvas></div>
    <aside id="legend">
      <div class="key"><b class="blue">BLEU 1</b> ‚Äî Acc√©l. <span class="kbd">Z</span> ‚Ä¢ Gauche <span class="kbd">Q</span> ‚Ä¢ Droite <span class="kbd">D</span></div>
      <div class="key"><b class="green">VERT 1</b> ‚Äî Acc√©l. <span class="kbd">‚Üë</span> ‚Ä¢ Gauche <span class="kbd">‚Üê</span> ‚Ä¢ Droite <span class="kbd">‚Üí</span></div>
      <div class="key"><b class="blue">BLEU 2</b> ‚Äî Acc√©l. <span class="kbd">O</span> ‚Ä¢ Gauche <span class="kbd">K</span> ‚Ä¢ Droite <span class="kbd">M</span></div>
      <div class="key"><b class="green">VERT 2</b> ‚Äî Acc√©l. <span class="kbd">8</span> ‚Ä¢ Gauche <span class="kbd">4</span> ‚Ä¢ Droite <span class="kbd">6</span> (pav√© num.)</div>

      <button id="toggleRules">Afficher / Masquer les r√®gles</button>
      <div class="key rules" id="rulesBox">
        <h3>R√®gles du jeu</h3>
        <div class="muted">Dur√©e 120 s ¬∑ 2 √©quipes (Bleu / Vert) ¬∑ 4 serpents</div>
        <ul>
          <li>Terrain <b>12√ó12</b> cellules. Bases : Bleu en haut & bas, Vert √† gauche & droite.</li>
          <li>Chaque serpent d√©marre dans sa base, avance en continu (20% vitesse max).</li>
          <li>Acc√©l√©ration en maintenant la touche d√©di√©e (cf. contr√¥les).</li>
          <li>D√©placements : tourner √† gauche/droite, jamais reculer.</li>
          <li>Il y a en permanence <b>6 ≈ìufs</b> sur le terrain (respawn auto).</li>
          <li>T√™te sur ≈ìuf ‚Üí <b>+1</b> de queue.</li>
          <li>Si une t√™te touche une <b>queue</b> (√† soi, alli√©, ennemi) ‚Üí la queue est perdue (t√™te seule).</li>
          <li>La <b>langue</b> (1 case devant la t√™te) tue une t√™te adverse si elle la touche (la queue du mort reste).</li>
          <li>Sortir du terrain = <b>mort</b> et <b>perte totale</b> de la queue.</li>
          <li><b>Score √©quipe</b> = somme des longueurs de queue des 2 serpents.</li>
          <li>Affichage du <b>record</b> de longueur max d‚Äôun serpent pendant la partie.</li>
        </ul>
        <h3 style="margin-top:10px;">D√©partager en cas d‚Äô√©galit√©</h3>
        <ul>
          <li>1) √âquipe avec le <b>serpent ayant la plus grande queue</b>.</li>
          <li>2) √âquipe avec le <b>plus de serpents vivants</b>.</li>
          <li>3) Sinon, <b>serpent le plus proche du centre</b> (distance affich√©e).</li>
        </ul>
      </div>

      <div class="key" id="result"></div>
    </aside>
  </section>
</div>

<script>
// --- IE9+ compatibility helpers ---
window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || function(cb){ return setTimeout(function(){ cb(+new Date()); }, 16); };
window.cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame || clearTimeout;

(function(){
  // ======== CONSTANTES 12√ó12 ========
  var COLS=12, ROWS=12, CELL=40; // 12x12 cases de 40px
  var BOARD_W=COLS*CELL, BOARD_H=ROWS*CELL;

  // Ajuste le canvas √† la taille calcul√©e (√©vite d'oublier si tu changes plus tard)
  var canvas=document.getElementById('canvas');
  canvas.width = BOARD_W; canvas.height = BOARD_H;
  var ctx=canvas.getContext('2d');

  var EGGS_TARGET=6, GAME_DURATION=120.0, MAX_SPEED=6.0, BASE_SPEED=MAX_SPEED*0.20, TONGUE_LEN=1;
  var DIRS={up:{x:0,y:-1}, right:{x:1,y:0}, down:{x:0,y:1}, left:{x:-1,y:0}};
  var TEAM_BLUE=0, TEAM_GREEN=1;
  var KEY={Z:90,Q:81,D:68,O:79,K:75,M:77,LEFT:37,UP:38,RIGHT:39,NUM4:100,NUM6:102,NUM8:104};

  var timeEl=document.getElementById('time'), scoreBlueEl=document.getElementById('scoreBlue'), scoreGreenEl=document.getElementById('scoreGreen'), recordEl=document.getElementById('record'), resultEl=document.getElementById('result');

  var snakes, eggs, timer, lastTs, rafId, recordMax;
  function rndInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}
  function inBounds(x,y){return x>=0&&x<COLS&&y>=0&&y<ROWS}
  function cellKey(x,y){return x+","+y}
  function dist2center(x,y){var cx=(COLS-1)/2,cy=(ROWS-1)/2,dx=x-cx,dy=y-cy;return Math.sqrt(dx*dx+dy*dy)}
  function makeSnake(id,team,x,y,dir){return {id:id,team:team,head:{x:x,y:y},dir:dir,pendingTurn:null,alive:true,speed:BASE_SPEED,progress:0,body:[],maxLength:0}}

  function reset(){
    // ======== POSITIONS DE D√âPART ADAPT√âES AU 12√ó12 ========
    // Centre entre 5 et 6 ‚Üí on utilise 6 pour x/y centraux
    snakes=[
      makeSnake('B1',TEAM_BLUE,6,1,DIRS.down),   // bleu haut ‚Üí descend
      makeSnake('B2',TEAM_BLUE,6,11,DIRS.up),    // bleu bas ‚Üí monte
      makeSnake('G1',TEAM_GREEN,1,6,DIRS.right), // vert gauche ‚Üí droite
      makeSnake('G2',TEAM_GREEN,11,6,DIRS.left)  // vert droite ‚Üí gauche
    ];
    eggs=[]; timer=GAME_DURATION; lastTs=null; recordMax=0; refillEggs(); resultEl.textContent='';
    if(rafId) cancelAnimationFrame(rafId);
    rafId=requestAnimationFrame(loop);
    draw();
  }

  function occupiedSet(){var o={}; for(var i=0;i<snakes.length;i++){var s=snakes[i]; if(s.alive) o[cellKey(s.head.x,s.head.y)]=true; for(var j=0;j<s.body.length;j++) o[cellKey(s.body[j].x,s.body[j].y)]=true;} return o; }
  function refillEggs(){var occ=occupiedSet(); while(eggs.length<EGGS_TARGET){var x=rndInt(0,COLS-1),y=rndInt(0,ROWS-1),k=cellKey(x,y); if(!occ[k]){var dup=false; for(var i=0;i<eggs.length;i++){if(eggs[i].x===x&&eggs[i].y===y){dup=true;break}} if(!dup) eggs.push({x:x,y:y});}}}

  var pressed={}; document.addEventListener('keydown',function(e){pressed[e.keyCode]=true}); document.addEventListener('keyup',function(e){pressed[e.keyCode]=false});
  function handleInput(){turnIf(snakes[0],KEY.Q,KEY.D); accelIf(snakes[0],KEY.Z); turnIf(snakes[2],KEY.LEFT,KEY.RIGHT); accelIf(snakes[2],KEY.UP); turnIf(snakes[1],KEY.K,KEY.M); accelIf(snakes[1],KEY.O); turnIf(snakes[3],KEY.NUM4,KEY.NUM6); accelIf(snakes[3],KEY.NUM8);} 
  function accelIf(s,k){if(!s.alive) return; s.speed=pressed[k]?MAX_SPEED:BASE_SPEED}
  function turnIf(s,l,r){if(!s.alive) return; var L=!!pressed[l], R=!!pressed[r]; if(L&&!R) s.pendingTurn='left'; else if(R&&!L) s.pendingTurn='right'}
  function applyTurn(s){if(!s.pendingTurn) return; var d=s.dir; if(s.pendingTurn==='left'){if(d===DIRS.up) s.dir=DIRS.left; else if(d===DIRS.left) s.dir=DIRS.down; else if(d===DIRS.down) s.dir=DIRS.right; else if(d===DIRS.right) s.dir=DIRS.up;} else {if(d===DIRS.up) s.dir=DIRS.right; else if(d===DIRS.right) s.dir=DIRS.down; else if(d===DIRS.down) s.dir=DIRS.left; else if(d===DIRS.left) s.dir=DIRS.up;} s.pendingTurn=null}

  function step(dt){
    timer-=dt; if(timer<0) timer=0; handleInput();
    for(var i=0;i<snakes.length;i++){var s=snakes[i]; if(!s.alive) continue; s.progress+=s.speed*dt;}
    var any=true; while(any){ any=false; 
      for(var i=0;i<snakes.length;i++){
        var s=snakes[i]; if(!s.alive) continue;
        if(s.progress>=1){
          any=true; s.progress-=1; applyTurn(s);
          var nx=s.head.x+s.dir.x, ny=s.head.y+s.dir.y;
          if(!inBounds(nx,ny)){ s.alive=false; s.body=[]; continue; }
          s.body.push({x:s.head.x,y:s.head.y});
          var grew=false;
          for(var e=0;e<eggs.length;e++){ if(eggs[e].x===nx&&eggs[e].y===ny){ eggs.splice(e,1); grew=true; refillEggs(); break; } }
          s.head={x:nx,y:ny};
          if(collidesAnyTail(s)){ s.body=[]; }
          else if(!grew){ if(s.body.length>0) s.body.shift(); }
          if(s.body.length>s.maxLength) s.maxLength=s.body.length;
          if(s.maxLength>recordMax) recordMax=s.maxLength;
        }
      }
    }
    // Langues : tuent une t√™te sans vider sa queue
    // Langues : tuent une t√™te sans vider sa queue
    for (var i = 0; i < snakes.length; i++) {
      var a = snakes[i];
      if (!a.alive) continue;
      var tx = a.head.x + a.dir.x * TONGUE_LEN;
      var ty = a.head.y + a.dir.y * TONGUE_LEN;
      if (!inBounds(tx, ty)) continue;

      for (var j = 0; j < snakes.length; j++) {
        if (i === j) continue;
        var v = snakes[j];
        if (!v.alive) continue;
        if (v.head.x === tx && v.head.y === ty) {
          // ‚ö†Ô∏è on tue SEULEMENT la t√™te
          v.alive = false;
          // NE PAS faire: v.body = [];
        }
      }
    }

    var b=0,g=0; for(var i=0;i<snakes.length;i++){var sn=snakes[i], len=sn.body.length; if(sn.team===TEAM_BLUE) b+=len; else g+=len;}
    scoreBlueEl.textContent=b; scoreGreenEl.textContent=g; recordEl.textContent=recordMax; timeEl.textContent=timer.toFixed(1);
    if(timer<=0) endGame();
  }
  //function collidesAnyTail(s){for(var i=0;i<snakes.length;i++){var o=snakes[i]; for(var t=0;t<o.body.length;t++){if(s.head.x===o.body[t].x && s.head.y===o.body[t].y) return true;}} return false}

  function collidesAnyTail(s) {
    for (var i = 0; i < snakes.length; i++) {
      var o = snakes[i];
      for (var t = 0; t < o.body.length; t++) {
        if (s.head.x === o.body[t].x && s.head.y === o.body[t].y) return true;
      }
    }
    return false;
  }

  // Dessin
  function draw(){
    ctx.clearRect(0,0,BOARD_W,BOARD_H);
    // grille
    ctx.save(); ctx.strokeStyle='#2f3447'; ctx.lineWidth=1;
    for(var x=0;x<=COLS;x++){ctx.beginPath();ctx.moveTo(x*CELL+0.5,0);ctx.lineTo(x*CELL+0.5,BOARD_H);ctx.stroke();}
    for(var y=0;y<=ROWS;y++){ctx.beginPath();ctx.moveTo(0,y*CELL+0.5);ctx.lineTo(BOARD_W,y*CELL+0.5);ctx.stroke();}
    ctx.restore();

    // anneaux concentriques (12x12 ‚Üí 5 anneaux pour rester √† l'int√©rieur)
    ctx.save(); ctx.strokeStyle='rgba(20,30,60,.35)'; ctx.lineWidth=2; var cx=BOARD_W/2, cy=BOARD_H/2; for(var r=1;r<=5;r++){ctx.beginPath(); ctx.arc(cx,cy,r*CELL,0,Math.PI*2); ctx.stroke();}
    ctx.restore();

    // bases (orient√©es vers le centre)
    drawBaseArc(6,0,'blue',-Math.PI,Math.PI);           // haut ‚Üí ouvert vers le bas
    drawBaseArc(6,11,'blue',-Math.PI,Math.PI);          // bas ‚Üí ouvert vers le haut
    drawBaseArc(0,6,'green',-Math.PI,Math.PI); // gauche ‚Üí ouvert vers la droite
    drawBaseArc(11,6,'green',-Math.PI,Math.PI); // droite ‚Üí ouvert vers la gauche

    // oeufs
    for(var i=0;i<eggs.length;i++){drawEgg(eggs[i].x,eggs[i].y)}

    // queues
    for(var s=0;s<snakes.length;s++){var sn=snakes[s], col=sn.team===TEAM_BLUE?'#45b5ff':'#46d980'; for(var t=0;t<sn.body.length;t++) drawCell(sn.body[t].x,sn.body[t].y,col,0.85)}
    // t√™tes + langues
    for(var s=0;s<snakes.length;s++){
      var sn=snakes[s];
      if(sn.alive){
        var col=sn.team===TEAM_BLUE?'#69c6ff':'#73e59a';
        drawHead(sn.head.x,sn.head.y,col);
        var tx=sn.head.x+sn.dir.x*TONGUE_LEN, ty=sn.head.y+sn.dir.y*TONGUE_LEN;
        if(inBounds(tx,ty)) drawCellOutline(tx,ty,'#e6f2ff');
      } else {
        drawHead(sn.head.x,sn.head.y,'#7a7f92');
      }
    }
  }
  function drawCell(x,y,color,alpha){ctx.save(); if(alpha!=null) ctx.globalAlpha=alpha; ctx.fillStyle=color; ctx.fillRect(x*CELL+4,y*CELL+4,CELL-8,CELL-8); ctx.restore();}
  function drawCellOutline(x,y,color){ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.strokeRect(x*CELL+8,y*CELL+8,CELL-16,CELL-16); ctx.restore();}
  function drawHead(x,y,color){ctx.save(); var px=x*CELL+CELL/2, py=y*CELL+CELL/2; var g=ctx.createRadialGradient(px-6,py-6,6,px,py,CELL*0.42); g.addColorStop(0,'#ffffff'); g.addColorStop(0.15,color); g.addColorStop(1,'#2b2f46'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(px,py,CELL*0.36,0,Math.PI*2); ctx.fill(); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(px+CELL*0.1,py-CELL*0.1,3,0,Math.PI*2); ctx.fill(); ctx.restore();}
  function drawBaseArc(cx,cy,team,start,end){var px=cx*CELL+CELL/2, py=cy*CELL+CELL/2; ctx.save(); ctx.lineWidth=16; ctx.strokeStyle= team==='blue'? '#45b5ff':'#46d980'; ctx.shadowColor=team==='blue'? '#2aa8ff':'#28e07d'; ctx.shadowBlur=14; ctx.beginPath(); ctx.arc(px,py,CELL*0.66,start,end,false); ctx.stroke(); ctx.restore();}
  function drawEgg(x,y){var px=x*CELL+CELL/2, py=y*CELL+CELL/2; var rg=ctx.createRadialGradient(px-4,py-6,2,px,py,14); rg.addColorStop(0,'#fff5c9'); rg.addColorStop(0.35,'#fde47a'); rg.addColorStop(1,'#e2b14a'); ctx.save(); ctx.fillStyle=rg; ctx.shadowColor='#ffe07a'; ctx.shadowBlur=10; ctx.beginPath(); ctx.arc(px,py,12,0,Math.PI*2); ctx.fill(); ctx.restore();}

  function loop(ts){ if(lastTs==null) lastTs=ts; var dt=Math.min(0.05,(ts-lastTs)/1000); lastTs=ts; step(dt); draw(); if(timer>0) rafId=requestAnimationFrame(loop); }

  function endGame(){
    var bTot=0,gTot=0,bAlive=0,gAlive=0,bMax=0,gMax=0,bClose=Infinity,gClose=Infinity;
    for(var i=0;i<snakes.length;i++){
      var s=snakes[i], len=s.body.length;
      if(s.team===TEAM_BLUE){
        bTot+=len; if(s.alive)bAlive++; if(len>bMax)bMax=len;
        var d=dist2center(s.head.x,s.head.y); if(d<bClose)bClose=d;
      } else {
        gTot+=len; if(s.alive)gAlive++; if(len>gMax)gMax=len;
        var d2=dist2center(s.head.x,s.head.y); if(d2<gClose)gClose=d2;
      }
    }
    var winner=null, reason='';
    if(bTot!==gTot){winner=(bTot>gTot)?'BLEU':'VERT'; reason='Somme des queues';}
    else if(bMax!==gMax){winner=(bMax>gMax)?'BLEU':'VERT'; reason='Robot avec la plus grande queue';}
    else if(bAlive!==gAlive){winner=(bAlive>gAlive)?'BLEU':'VERT'; reason='Plus de robots vivants';}
    else if(bClose!==gClose){winner=(bClose<gClose)?'BLEU':'VERT'; reason='Robot le plus proche du centre';}
    else {winner='√âGALIT√â PARFAITE'; reason='ind√©cidable';}

    var text = '';
    text += 'FIN DE PARTIE\n';
    text += 'Total Bleu: '+bTot+' | Total Vert: '+gTot+'\n';
    text += 'Max queue Bleu: '+bMax+' | Max queue Vert: '+gMax+'\n';
    text += 'Robots vivants Bleu: '+bAlive+' | Vert: '+gAlive+'\n';
    text += 'Plus proche du centre Bleu: '+(isFinite(bClose)?bClose.toFixed(2):'-')+' | Vert: '+(isFinite(gClose)?gClose.toFixed(2):'-')+'\n';
    text += 'Record longueur (tous) = '+recordMax+'\n\n';
    text += 'Vainqueur: '+winner+' ‚Äî Crit√®re: '+reason;
    resultEl.textContent = text;
  }

  // Encadr√© R√àGLES : afficher/masquer
  var toggleBtn = document.getElementById('toggleRules');
  var rulesBox  = document.getElementById('rulesBox');
  toggleBtn.onclick = function(){ 
    if(rulesBox.className.indexOf('hidden') === -1) rulesBox.className += ' hidden';
    else rulesBox.className = rulesBox.className.replace(' hidden','');
  };

  document.getElementById('restart').addEventListener('click',reset);
  reset();
})();
</script>
</body>
</html>
